#!/bin/sh
set -e

source ./util.sh

# Ensure the required variables are present
checkVars \
    REPO \
    BRANCH \
    BUILD_STATUS \
    BUILD_NUMBER \
    BUILD_STARTED \
    BUILD_FINISHED \
    BUILD_LINK \
    COMMIT \
    COMMIT_LINK \
    COMMIT_MESSAGE \
    COMMIT_AUTHOR \
        || exit $?

# Construct the notification message
secs="$(($BUILD_FINISHED - $BUILD_STARTED))"
message="*${REPO/_/\\_}$(test -n "$TAG" -a "$TAG" != "<nil>" && echo ":$TAG") [$BRANCH]* #$BUILD_NUMBER: *$(upper $BUILD_STATUS)* in $(date -u -d @$secs '+%Mm %Ss')
[${BUILD_LINK/_/\\_}](${BUILD_LINK/_/\\_})
[#${COMMIT:0:7}](${COMMIT_LINK/_/\\_}) (${COMMIT_AUTHOR}): _${COMMIT_MESSAGE/_/\\_}_"

# Send the message with the telegram api
telegram-api sendMessage "$message" "disable_web_page_preview=true"
